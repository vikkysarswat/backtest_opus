"""\nFlask Backtester Application\nMain entry point for the trading backtesting platform\n"""\n\nimport os\nimport logging\nfrom pathlib import Path\nfrom datetime import datetime\n\nfrom flask import Flask, render_template, redirect, url_for, flash, request, jsonify, session\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_login import LoginManager, login_user, logout_user, login_required, current_user\nfrom werkzeug.security import generate_password_hash, check_password_hash\n\nfrom config import get_config, Config\n\n# Initialize Flask extensions\ndb = SQLAlchemy()\nlogin_manager = LoginManager()\n\n\ndef create_app(config_class=None):\n    """Application factory function"""\n    \n    app = Flask(__name__)\n    \n    # Load configuration\n    if config_class is None:\n        config_class = get_config()\n    app.config.from_object(config_class)\n    \n    # Ensure required directories exist\n    Path(app.config['UPLOAD_FOLDER']).mkdir(parents=True, exist_ok=True)\n    Path(app.config['RESULTS_FOLDER']).mkdir(parents=True, exist_ok=True)\n    Path(app.config['LOG_FILE']).parent.mkdir(parents=True, exist_ok=True)\n    \n    # Configure logging\n    setup_logging(app)\n    \n    # Initialize extensions\n    db.init_app(app)\n    login_manager.init_app(app)\n    login_manager.login_view = 'auth.login'\n    login_manager.login_message_category = 'info'\n    \n    # Import and register blueprints\n    from routes.auth import auth_bp\n    from routes.dashboard import dashboard_bp\n    from routes.upload import upload_bp\n    from routes.strategy import strategy_bp\n    from routes.backtest import backtest_bp\n    from routes.results import results_bp\n    from routes.api import api_bp\n    \n    app.register_blueprint(auth_bp, url_prefix='/auth')\n    app.register_blueprint(dashboard_bp, url_prefix='/dashboard')\n    app.register_blueprint(upload_bp, url_prefix='/upload')\n    app.register_blueprint(strategy_bp, url_prefix='/strategy')\n    app.register_blueprint(backtest_bp, url_prefix='/backtest')\n    app.register_blueprint(results_bp, url_prefix='/results')\n    app.register_blueprint(api_bp, url_prefix='/api')\n    \n    # Register error handlers\n    register_error_handlers(app)\n    \n    # Create database tables\n    with app.app_context():\n        db.create_all()\n    \n    # Root route\n    @app.route('/')\n    def index():\n        if current_user.is_authenticated:\n            return redirect(url_for('dashboard.home'))\n        return redirect(url_for('auth.login'))\n    \n    # Context processors\n    @app.context_processor\n    def inject_globals():\n        return {\n            'current_year': datetime.now().year,\n            'app_name': 'Flask Backtester'\n        }\n    \n    return app\n\n\ndef setup_logging(app):\n    """Configure application logging"""\n    log_level = getattr(logging, app.config.get('LOG_LEVEL', 'INFO'))\n    \n    # Create formatter\n    formatter = logging.Formatter(\n        '[%(asctime)s] %(levelname)s in %(module)s: %(message)s'\n    )\n    \n    # File handler\n    file_handler = logging.FileHandler(app.config['LOG_FILE'])\n    file_handler.setLevel(log_level)\n    file_handler.setFormatter(formatter)\n    \n    # Stream handler for console\n    stream_handler = logging.StreamHandler()\n    stream_handler.setLevel(log_level)\n    stream_handler.setFormatter(formatter)\n    \n    # Add handlers to app logger\n    app.logger.addHandler(file_handler)\n    app.logger.addHandler(stream_handler)\n    app.logger.setLevel(log_level)\n\n\ndef register_error_handlers(app):\n    """Register custom error handlers"""\n    \n    @app.errorhandler(404)\n    def not_found_error(error):\n        return render_template('errors/404.html'), 404\n    \n    @app.errorhandler(500)\n    def internal_error(error):\n        db.session.rollback()\n        return render_template('errors/500.html'), 500\n    \n    @app.errorhandler(403)\n    def forbidden_error(error):\n        return render_template('errors/403.html'), 403\n\n\n# User model\nclass User(db.Model):\n    """User model for authentication"""\n    __tablename__ = 'users'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(120), unique=True, nullable=False, index=True)\n    password_hash = db.Column(db.String(256), nullable=False)\n    name = db.Column(db.String(100), nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    last_login = db.Column(db.DateTime)\n    is_active = db.Column(db.Boolean, default=True)\n    \n    # Relationships\n    strategies = db.relationship('Strategy', backref='user', lazy='dynamic')\n    backtests = db.relationship('Backtest', backref='user', lazy='dynamic')\n    \n    def set_password(self, password):\n        """Hash and set password"""\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        """Verify password"""\n        return check_password_hash(self.password_hash, password)\n    \n    @property\n    def is_authenticated(self):\n        return True\n    \n    @property\n    def is_anonymous(self):\n        return False\n    \n    def get_id(self):\n        return str(self.id)\n    \n    def __repr__(self):\n        return f'<User {self.email}>'\n\n\nclass Strategy(db.Model):\n    """Strategy model for storing user-defined strategies"""\n    __tablename__ = 'strategies'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    name = db.Column(db.String(100), nullable=False)\n    description = db.Column(db.Text)\n    config = db.Column(db.JSON, nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    is_active = db.Column(db.Boolean, default=True)\n    \n    # Relationships\n    backtests = db.relationship('Backtest', backref='strategy', lazy='dynamic')\n    \n    def __repr__(self):\n        return f'<Strategy {self.name}>'\n\n\nclass Backtest(db.Model):\n    """Backtest model for storing backtest results"""\n    __tablename__ = 'backtests'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    strategy_id = db.Column(db.Integer, db.ForeignKey('strategies.id'), nullable=False)\n    name = db.Column(db.String(100), nullable=False)\n    start_date = db.Column(db.Date, nullable=False)\n    end_date = db.Column(db.Date, nullable=False)\n    initial_capital = db.Column(db.Float, default=100000)\n    results = db.Column(db.JSON)\n    trades_file = db.Column(db.String(255))\n    equity_file = db.Column(db.String(255))\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    status = db.Column(db.String(20), default='pending')\n    \n    def __repr__(self):\n        return f'<Backtest {self.name}>'\n\n\nclass DataFile(db.Model):\n    """Data file model for tracking uploaded CSV files"""\n    __tablename__ = 'data_files'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    filename = db.Column(db.String(255), nullable=False)\n    original_filename = db.Column(db.String(255), nullable=False)\n    file_type = db.Column(db.String(20), nullable=False)\n    file_path = db.Column(db.String(500), nullable=False)\n    file_size = db.Column(db.Integer)\n    row_count = db.Column(db.Integer)\n    start_date = db.Column(db.DateTime)\n    end_date = db.Column(db.DateTime)\n    columns = db.Column(db.JSON)\n    uploaded_at = db.Column(db.DateTime, default=datetime.utcnow)\n    is_valid = db.Column(db.Boolean, default=True)\n    validation_errors = db.Column(db.JSON)\n    \n    def __repr__(self):\n        return f'<DataFile {self.original_filename}>'\n\n\n@login_manager.user_loader\ndef load_user(user_id):\n    """Load user by ID for Flask-Login"""\n    return User.query.get(int(user_id))\n\n\n# Create application instance\napp = create_app()\n\n\nif __name__ == '__main__':\n    app.run(debug=True, host='0.0.0.0', port=5000)\n